---
title: "Candidatos"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Read files processed in run_sensitive_data.R
df_FORM_RAW = read_rds(here::here(".vault/output/data/df_FORM5.rds"))
df_Status_RAW = read_rds(here::here(".vault/output/data/df_FORM6.rds"))
df_AIM = read_rds(here::here(".vault/output/data/df_AIM.rds")) %>% select(RUT, AIM_DIRt)
df_Bank = read_rds(here::here(".vault/output/data/df_Bank.rds"))

```
Construido: `r Sys.time()`  

---  


## Summary

```{r summary, include=FALSE}

# Read main df_FORM_RAW contains everyone that filled the form. 
# In run_sensitive_data is joined by SDG (id/RUT). Only the ones that completed the experiment have id.

cuota_Ca = 20
cuota_Cc = 20
cuota_EX = 40

DF_raw = 
  df_FORM_RAW %>% 
  left_join(df_AIM, by = "RUT") %>% 
  select(id, RUT, AIM_DIRt, FORM5_02_DIR, FORM5_03_DIR, FORM5_04_DIR, FORM5_05_DIR, FORM5_06_DIR, FORM5_07_DIR, FORM5_08_DIR) %>% 
  
  rename(
    email = FORM5_02_DIR, 
    name = FORM5_03_DIR,
    edad = FORM5_04_DIR,
    sexo = FORM5_05_DIR,
    years_education = FORM5_06_DIR,
    comuna = FORM5_07_DIR,
    telefono = FORM5_08_DIR
    ) %>% 
  
  mutate(grupo = 
           case_when(
            AIM_DIRt == "d" | AIM_DIRt == "e" ~ "EX",
            AIM_DIRt == "c2" | AIM_DIRt == "c3" ~ "Cc",
            AIM_DIRt == "c1a" | AIM_DIRt == "c1b" | AIM_DIRt == "ab" ~ "Ca",
            TRUE ~ NA_character_),

         edad = 
           case_when(
             between(edad, 25, 33) ~ "25-33",
             between(edad, 34, 42) ~ "34-42",
             between(edad, 43, 50) ~ "43-50",
             edad < 25 ~ "demasiado joven",
             edad > 50 ~ "demasiado viejo"),
         
         completed = 
           case_when(
             is.na(id) ~ "n",
             TRUE ~ "OK")
         )

  
DF = 
  DF_raw %>% 
  # Filter out by age, sex and socioeconomic group
  filter(sexo != "No binario") %>%
  filter(edad != "demasiado viejo" & edad != "demasiado joven") %>% 
  drop_na(grupo) %>% 
  
  select(id, RUT, completed, edad, sexo, grupo, edad, telefono, email, name, comuna)



table_done_temp =
  DF %>% 
  select(-RUT) %>% 
  count(grupo, completed, edad, sexo) %>% 
  mutate(grupo = paste0(grupo, "_", completed)) %>% 
  select(-completed) %>% 
  pivot_wider(names_from = grupo, values_from = n) #, names_prefix = "n_"


# If we don't have certain types of people, create columns
cols = c(Cc_n = 0, Ca_n = 0, EX_n = 0, Cc_OK = 0, Ca_OK = 0, EX_OK = 0)
table_done_temp = tibble::add_column(table_done_temp, !!!cols[setdiff(names(cols), names(table_done_temp))]) 

# If table is empty, create it
if (nrow(table_done_temp) == 0) table_done_temp = tibble(edad = NA_character_, sexo = NA_character_, Cc_n = 0, Ca_n = 0,  EX_n = 0,  Cc_OK = 0,  CONa_OK = 0,  EXP_OK = 0)
  
# Vulnerable group: groups d y e 50% of sample
# Non-vulnerable group: groups c3 y c2 25% of sample
# Non-vulnerable group: groups ab, c1a y c1b 25% of sample
  
table_done =
  table_done_temp %>% 
  complete(sexo = c("Masculino", "Femenino")) %>% 
  complete(edad = c("25-33", "34-42", "43-50"), nesting(sexo)) %>% 
  drop_na(edad, sexo) %>% 
  replace_na(list(Cc_n = 0, Ca_n = 0, EX_n = 0, Cc_OK = 0, Ca_OK = 0, EX_OK = 0)) %>% 
  mutate(GOAL_Ca = (Ca_OK - cuota_Ca),
         GOAL_Cc = (Cc_OK - cuota_Cc),
         GOAL_EX = (EX_OK - cuota_EX)) %>% 
  
  mutate(DIF_Ca = GOAL_Ca + Ca_n,
         DIF_Cc = GOAL_Cc + Cc_n,
         DIF_EX = GOAL_EX + EX_n) %>% 
  
  
  select(edad, sexo, Ca_OK, Cc_OK, EX_OK, GOAL_Ca, GOAL_Cc, GOAL_EX,	Ca_n, Cc_n, EX_n, DIF_Ca, DIF_Cc, DIF_EX) %>% 
  select(-matches("NA_", ignore.case = FALSE))

  # select(edad, sexo, CONa_OK, CONc_OK, EXP_OK, GOAL_CONa, GOAL_CONc, GOAL_EXP,	CONa_CALL, CONc_CALL, EXP_CALL) %>% 
  # select(-matches("NA_", ignore.case = FALSE))


table_WARNINGS = 
  table_done %>% 
  select(edad, sexo, matches("GOAL")) %>% 
  pivot_longer(GOAL_Ca:GOAL_EX) %>% 
  filter(value > -10)

```
   
  
```{r summary-table, echo=FALSE}

DT::datatable(table_done, options = list(dom = 't'), rownames = FALSE) %>% 
      DT::formatStyle(
        columns = c("GOAL_Ca", "GOAL_Cc", "GOAL_EX"), 
        target = "cell",
        color = DT::styleInterval(cuts = c(-10, 0), values = c("red", "orange", "green"))
        ) %>% 
  DT::formatStyle(
        columns = c("DIF_Ca", "DIF_Cc", "DIF_EX"), 
        target = "cell",
        color = DT::styleInterval(cuts = c(-10, 0), values = c("red", "orange", "green"))
        )
  # DT::formatStyle(c("DIF_Ca", "DIF_Cc", "DIF_EX"), 
  #                 backgroundColor = 'gray')
  #                 # backgroundColor = DT::styleInterval(cuts = c(-10, 0), c('gray', 'yellow', 'blue')))

```
**OK**: Completados  
**GOAL**: Cuantos faltan para llegar a las cuotas (40 grupo experimental, 20 cada grupo control)  
**n**: En la base, esperando llamada  
**DIF**: Si todos los de la base completaran el experimento, cuantos faltarian/sobrarian para llegar a la cuota  

- EXP: Vulnerable group: groups d y e 50% of sample (n = 240)  
- CONa: Non-vulnerable group: groups c3 y c2 25% of sample (n = 120)  
- CONc: Non-vulnerable group: groups ab, c1a y c1b 25% of sample (n = 120)  


---   

### WARNINGS

En estos grupos estamos cerca de llegar a la cuota (el objetivo es value = 0). Tener esto en cuenta a la hora de citar participantes.  

```{r warning-table, echo=FALSE}

DT::datatable(table_WARNINGS, options = list(dom = 't'), rownames = FALSE) %>% 
      DT::formatStyle(
        columns = c("value"), 
        target = "cell",
        color = DT::styleInterval(cuts = c(0), values = c("orange", "red"))
    )

```


---   

### Candidatos

Actualizar STATUS de Candidatos aqui: [http://cscn.uai.cl/lab/public/instruments/protocols/6/](http://cscn.uai.cl/lab/public/instruments/protocols/6/){target="_blank"}

```{r candidatos-table, echo=FALSE}

df_Status =
  df_Status_RAW %>%
  mutate(date = as.Date(datetime)) %>% 
  group_by(RUT) %>% 
  summarise(status = paste(paste0("[", date, "]: ", FORM6_01_RAW), collapse = ", "),
         notes =  paste(paste0("[", date, "]: ", FORM6_02_RAW), collapse = ", "), 
         .groups = "keep")

# Non filtered candidates
# DF_raw %>% 
#   filter(completed == "n") %>% 
#   drop_na(edad) %>% 
#   drop_na(grupo)

table_candidatos_long =
  DF %>% 
  left_join(df_Status, by = "RUT") %>% 
  filter(completed == "n") %>% 
  drop_na(edad) %>% 
  select(grupo, edad, sexo, RUT, name, telefono, email, comuna, status, notes)

DT::datatable(table_candidatos_long, filter = 'top', 
              options = list(
                dom = 'tip',
                # autoWidth = TRUE,
  columnDefs = list(list(width = '300px', targets = c("status", "notes")))))

```



---   


### Completados

Participantes que han completado el protocolo:  

```{r completed-table, echo=FALSE}

DF_completed = 
  DF %>% 
  filter(completed == "OK") %>% 
  select(-completed) %>% 
  
  # Join Bank information
  left_join(df_Bank %>% 
              select(id, Bank_01_DIR, Bank_02_DIR, Bank_03_DIR, Bank_04_DIR, Bank_05_DIR) %>% 
              mutate(datos_bancarios = paste0(Bank_01_DIR, " | RUT: ", Bank_02_DIR, " | ", Bank_03_DIR, " | ", Bank_04_DIR, " | ",  Bank_05_DIR)) %>% 
              select(id, datos_bancarios), 
            by = "id")




DT::datatable(DF_completed, filter = 'top', 
              options = list(
                dom = 'tip',
                autoWidth = TRUE))
```

---  

### Missing  

Tabla donde se muestra la suma de los participantes faltan en cada grupo.

```{r missing-totals-table, echo=FALSE}

missing_totals_table = 
  table_done %>% 
  select(edad, sexo, matches("GOAL"), matches("DIF")) %>% 
  mutate(missing_GOAL_Ca = (abs(GOAL_Ca) - GOAL_Ca)/2,
         missing_GOAL_Cc = (abs(GOAL_Cc) - GOAL_Cc)/2,
         missing_GOAL_EX = (abs(GOAL_EX) - GOAL_EX)/2,
         missing_DIF_Ca = (abs(DIF_Ca) - DIF_Ca)/2,
         missing_DIF_Cc = (abs(DIF_Cc) - DIF_Cc)/2,
         missing_DIF_EX = (abs(DIF_EX) - DIF_EX)/2) %>% 
  janitor::adorn_totals() %>% 
  select(edad, sexo, matches("missing"))

DT::datatable(missing_totals_table, options = list(dom = 't'), rownames = FALSE) %>% 
      DT::formatStyle(
        columns = c("missing_GOAL_Ca", "missing_GOAL_Cc", "missing_GOAL_EX", "missing_DIF_Ca", "missing_DIF_Cc", "missing_DIF_EX"), 
        target = "cell",
        color = DT::styleInterval(cuts = c(10, 20), values = c("green", "orange", "red"))
        ) %>% 
  formatStyle('edad',
              target = 'row',
              backgroundColor = styleEqual(c("Total"), c('gray'))
)
         
```

